#!/bin/sh
set -xe

# Function to expand tilde in paths
expand_path() {
    case "$1" in
        ~/*) echo "$HOME/${1#~/}" ;;
        ~) echo "$HOME" ;;
        *) echo "$1" ;;
    esac
}

# Handle usage
if [ $# -eq 1 ]; then
    ISO_PATH=""
    QCOW2_IMAGE=$(expand_path "$1")
elif [ $# -eq 2 ]; then
    ISO_PATH=$(expand_path "$1")
    QCOW2_IMAGE=$(expand_path "$2")
else
    echo "Usage:"
    echo "  $0 <qcow2_image>                 # Boot from existing image"
    echo "  $0 <iso_file> <qcow2_image>      # Install from ISO"
    exit 1
fi

# Check/create qcow2 directory
QCOW2_DIR=$(dirname "$QCOW2_IMAGE")
if [ ! -d "$QCOW2_DIR" ]; then
    echo "Creating directory: $QCOW2_DIR"
    mkdir -p "$QCOW2_DIR"
fi

echo "Configuration:"
[ -n "$ISO_PATH" ] && echo "ISO Path: $ISO_PATH"
echo "QCOW2 Image: $QCOW2_IMAGE"
echo ""

# Boot logic
if [ ! -f "$QCOW2_IMAGE" ]; then
    if [ -z "$ISO_PATH" ]; then
        echo "Error: QCOW2 image not found and no ISO provided to install from."
        exit 1
    fi

    if [ ! -f "$ISO_PATH" ]; then
        echo "Error: ISO file '$ISO_PATH' not found!"
        exit 1
    fi

    echo "Creating new disk image..."
    qemu-img create -f qcow2 "$QCOW2_IMAGE" 60G

    echo "Launching installation from ISO..."
    qemu-system-x86_64 -enable-kvm \
                       -m 8000 \
                       -cdrom "$ISO_PATH" \
                       -drive file="$QCOW2_IMAGE",if=virtio \
                       -boot d \
                       -netdev user,id=net0,hostfwd=tcp::2222-:22 \
                       -device virtio-net-pci,netdev=net0 \
                       -vga qxl \
                       -spice port=5930,addr=127.0.0.1,disable-ticketing=on \
                       -device virtio-serial-pci \
                       -device virtserialport,chardev=spicechannel0,name=com.redhat.spice.0 \
                       -chardev spicevmc,id=spicechannel0,name=vdagent \
                       -device ich9-intel-hda \
                       -device hda-micro,audiodev=hda \
                       -audiodev spice,id=hda \
                       -monitor stdio
else
    echo "Booting from existing disk..."
    qemu-system-x86_64 -enable-kvm \
                       -m 8000 \
                       -drive file="$QCOW2_IMAGE",if=virtio \
                       -boot c \
                       -netdev user,id=net0,hostfwd=tcp::2222-:22 \
                       -device virtio-net-pci,netdev=net0 \
                       -vga qxl \
                       -spice port=5930,addr=127.0.0.1,disable-ticketing=on \
                       -device virtio-serial-pci \
                       -device virtserialport,chardev=spicechannel0,name=com.redhat.spice.0 \
                       -chardev spicevmc,id=spicechannel0,name=vdagent \
                       -device ich9-intel-hda \
                       -device hda-micro,audiodev=hda \
                       -audiodev spice,id=hda \
                       -monitor stdio
fi
