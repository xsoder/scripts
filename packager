#!/usr/bin/env bash

draw_bar() {
    local percent=$1
    local cols=$(tput cols)
    local bar_size=$((cols - 8))
    local filled=$((percent * bar_size / 100))
    local empty=$((bar_size - filled))

    printf "\r["
    for ((i=0; i<filled; i++)); do printf "#"; done
    for ((i=0; i<empty; i++)); do printf "."; done
    printf "] %3d%%" "$percent"
}

create_tar() {
    local dir=$1
    local name
    name=$(basename "$dir").tar

    echo "[LOG] Creating tarball: $name"

    local total current percent
    total=$(find "$dir" -type f | wc -l)
    current=0

    tar -cf "$name" "$dir" --verbose 2>&1 \
    | while read -r file; do
        current=$((current + 1))
        percent=$((current * 100 / total))
        draw_bar "$percent"
    done

    draw_bar 100
    echo -e "\n[LOG] Tarball created: $name"
}

create_zip() {
    local dir=$1
    local name
    name=$(basename "$dir").zip

    echo "[LOG] Creating zip: $name"

    local total current percent
    total=$(find "$dir" -type f | wc -l)
    current=0

    zip -rv "$name" "$dir" 2>/dev/null | while read -r line; do
        if [[ "$line" == *"adding:"* ]]; then
            current=$((current + 1))
            percent=$((current * 100 / total))
            draw_bar "$percent"
        fi
    done

    draw_bar 100
    echo -e "\n[LOG] Zip created: $name"
}


if [ $# -lt 2 ]; then
    echo "Usage: $0 [tar|zip] <directory>"
    exit 1
fi

case $1 in
    tar) create_tar "$2" ;;
    zip) create_zip "$2" ;;
    *) echo "[ERROR] Unknown option: $1 (use tar|zip)" ;;
esac
