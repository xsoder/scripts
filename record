#!/usr/bin/env bash

save_dir="$HOME/media/Videos/Recordings"
mkdir -p "$save_dir"
pidfile="/tmp/ffmpeg-screen-record.pid"

if [ -f "$pidfile" ]; then
    kill -INT "$(cat "$pidfile")" 2>/dev/null
    rm "$pidfile"
    notify-send "Screen Recording Stopped"
    exit 0
fi

name=$(echo "" | dmenu -p "Recording name:")
[ -z "$name" ] && name="untitled_$(date '+%Y-%m-%d_%H-%M-%S')"

audio_src="$(pactl get-default-sink).monitor"
screen_size=$(xdpyinfo | awk '/dimensions:/ {print $2}')
outfile="$save_dir/${name// /_}.mkv"

notify-send "Screen Recording Started" "Saving to $outfile"
ffmpeg -y \
    -video_size "$screen_size" \
    -framerate 30 \
    -f x11grab -i :0.0 \
    -f pulse -i "$audio_src" \
    -c:v libx264 -preset ultrafast -crf 23 \
    -c:a aac -b:a 128k \
    "$outfile" >/dev/null 2>&1 &

echo $! > "$pidfile"
