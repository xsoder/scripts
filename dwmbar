#!/usr/bin/env bash

get_local_ip() {
    ip -4 addr show scope global | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n 1
}

get_battery_level() {
    cat /sys/class/power_supply/BAT*/capacity 2>/dev/null
}

get_battery_status() {
    cat /sys/class/power_supply/BAT*/status 2>/dev/null
}

last_notification_level=-1

while true; do
    localip="Leaked IP: $(get_local_ip)"
    datetime=$(date '+%Y-%m-%d %H:%M:%S')

    if ping -c 1 -W 1 8.8.8.8 > /dev/null 2>&1; then
        net_status="On"
    else
        net_status="Off"
    fi

    if nc -z localhost 3000 > /dev/null 2>&1; then
        server_status="Up"
    else
        server_status="Down"
    fi

    battery_level=$(get_battery_level)
    battery_status=$(get_battery_status)

    if [ "$battery_status" != "Charging" ]; then
        if [ "$battery_level" -le 20 ] && [ "$last_notification_level" -ne 20 ]; then
            notify-send -u critical "Battery Low" "Battery at ${battery_level}%"
            last_notification_level=20
        elif [ "$battery_level" -le 10 ] && [ "$last_notification_level" -ne 10 ]; then
            notify-send -u critical "Battery Very Low" "Battery at ${battery_level}%"
            last_notification_level=10
        fi
    else
        last_notification_level=-1
    fi

    xsetroot -name "Date: $datetime | $localip | Net: $net_status | Server: $server_status | Bat: ${battery_level}% ${battery_status}"

    sleep 5
done

